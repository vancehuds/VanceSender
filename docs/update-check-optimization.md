# 更新检查功能优化说明

本文记录本次“检查更新”功能的行为变化与实现重点，便于排查和后续维护。

## 背景

原有实现每次检查都会直接请求 GitHub，且在非纯数字版本标签下可能出现误报更新。
同时，启动自动检查会弹出“已是最新版本”等提示，体验偏噪音。

## 本次优化内容

### 1) 后端：请求策略与稳定性

- 增加 **10 分钟内存缓存（TTL）**，减少重复请求。
- 增加 **条件请求**：优先 `If-Modified-Since`，回退 `If-None-Match`。
- 收到 `304 Not Modified` 时，复用缓存结果。
- 保留 **Release 优先、Tag 兜底**：
  - 先查 `/releases/latest`
  - 若 `404` 再查 `/tags?per_page=1`
- 增加限流窗口处理（403/429），避免短时间内重复打满 GitHub API。

### 2) 后端：版本比较准确性

- 版本比较改为：
  1. `packaging.Version` 优先
  2. 纯数字版本 tuple 比较兜底
  3. 无法可靠比较时，**不判定有更新**（避免误报）
- 对稳定版用户默认不把预发布版本（alpha/beta/rc）视为可升级目标。

### 3) 后端：错误信息策略

- 面向前端返回更简洁、可理解的失败文案。
- 详细上下文（状态码、限流头、上游错误）写入后端日志，便于诊断。

### 4) 前端：交互优化

- 启动时自动检查改为 **静默模式**：
  - 仅发现新版本时提示
  - 不再弹“已是最新版本”或普通失败提示
- 手动点击“检查更新”仍保留可见反馈。
- 增加并发保护，避免重复触发多次检查请求。

## 用户可感知变化

- 启动界面更安静，不再出现不必要提示。
- 在 GitHub API 波动或限流场景下，检查结果更稳定。
- 版本标签不规范时，不会再因为字符串不同而误报“有新版本”。

## 兼容性说明

- 对外接口仍是 `GET /api/v1/settings/update-check`。
- 响应结构保持兼容（`UpdateCheckResponse`），前端无需改接口路径。
- 新增依赖：`packaging`（用于可靠版本比较）。
